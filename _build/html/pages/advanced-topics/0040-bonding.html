<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>L23network &mdash; Fuel for OpenStack 3.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Fuel for OpenStack 3.0 documentation" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">Fuel for OpenStack 3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">L23network</a><ul>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#l2-network-configuation-open-vswitch-only">L2 network configuation (Open vSwitch only)</a></li>
<li><a class="reference internal" href="#l3-network-configuration">L3 network configuration</a></li>
<li><a class="reference internal" href="#bonding">Bonding</a></li>
<li><a class="reference internal" href="#q-vlan-access-ports">802.1q vlan access ports</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/pages/advanced-topics/0040-bonding.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="l23network">
<h1>L23network<a class="headerlink" href="#l23network" title="Permalink to this headline">¶</a></h1>
<p>NOTE:  THIS DOCUMENT HAS NOT BEEN EDITED AND IS NOT READY FOR PUBLIC CONSUMPTION.</p>
<p>Puppet module for configuring network interfaces on 2nd and 3rd level (802.1q vlans, access ports, NIC-bonding, assign IP addresses, dhcp, and interfaces without IP addresses).</p>
<p>Can work together with Open vSwitch or standard linux way.</p>
<p>At this moment we support Centos 6.3 (RHEL6) and Ubuntu 12.04 or above.</p>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Place this module at /etc/puppet/modules or on another path that contains your puppet modules.</p>
<p>Include L23network module and initialize it. I recommend to do it in an early stage:</p>
<div class="highlight-python"><pre>#Network configuration
stage {'netconfig':
  before  =&gt; Stage['main'],
}
class {'l23network': stage=&gt; 'netconfig'}</pre>
</div>
<p>If you do not plan to use Open vSwitch &#8211; you can disable it:</p>
<div class="highlight-python"><pre>class {'l23network': use_ovs=&gt;false, stage=&gt; 'netconfig'}</pre>
</div>
</div>
<div class="section" id="l2-network-configuation-open-vswitch-only">
<h2>L2 network configuation (Open vSwitch only)<a class="headerlink" href="#l2-network-configuation-open-vswitch-only" title="Permalink to this headline">¶</a></h2>
<p>Current layout is:
* <em>bridges</em> &#8211; A &#8220;Bridge&#8221; is a virtual ethernet L2 switch. You can plug ports into it.
* <em>ports</em> &#8211; A Port is an interface you plug into the bridge (switch). It&#8217;s a virtual.  (virtual what?)
* <em>interface</em> &#8211; A physical implementation of port.</p>
<p>Then in your manifest you can either use the things as parameterized classes:</p>
<div class="highlight-python"><pre>class {"l23network": }

l23network::l2::bridge{"br-mgmt": }
l23network::l2::port{"eth0": bridge =&gt; "br-mgmt"}
l23network::l2::port{"mmm0": bridge =&gt; "br-mgmt"}
l23network::l2::port{"mmm1": bridge =&gt; "br-mgmt"}

l23network::l2::bridge{"br-ex": }
l23network::l2::port{"eth0": bridge =&gt; "br-ex"}
l23network::l2::port{"eth1": bridge =&gt; "br-ex", ifname_order_prefix='ovs'}
l23network::l2::port{"eee0": bridge =&gt; "br-ex", skip_existing =&gt; true}
l23network::l2::port{"eee1": bridge =&gt; "br-ex", type=&gt;'internal'}</pre>
</div>
<p>You can define type for the port. Port type can be
&#8216;system&#8217;, &#8216;internal&#8217;, &#8216;tap&#8217;, &#8216;gre&#8217;, &#8216;ipsec_gre&#8217;, &#8216;capwap&#8217;, &#8216;patch&#8217;, &#8216;null&#8217;.
If you do not define type for port (or define &#8216;&#8217;) &#8211; ovs-vsctl will have default behavior
(see <a class="reference external" href="http://openvswitch.org/cgi-bin/ovsman.cgi?page=utilities%2Fovs-vsctl.8">http://openvswitch.org/cgi-bin/ovsman.cgi?page=utilities%2Fovs-vsctl.8</a>).</p>
<p>You can use <em>skip_existing</em> option if you do not want to interrupt configuration while adding an existing port or bridge.</p>
</div>
<div class="section" id="l3-network-configuration">
<h2>L3 network configuration<a class="headerlink" href="#l3-network-configuration" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="highlight-python"><pre>### Simple IP address definition, DHCP or address-less interfaces
l23network::l3::ifconfig {"eth0": ipaddr=&gt;'192.168.1.1/24'}
l23network::l3::ifconfig {"xXxXxXx":
    interface =&gt; 'eth1',
    ipaddr    =&gt; '192.168.2.1',
    netmask   =&gt; '255.255.255.0'
}
l23network::l3::ifconfig {"eth2": ipaddr=&gt;'dhcp'}
l23network::l3::ifconfig {"eth3": ipaddr=&gt;'none'}</pre>
</div>
</div></blockquote>
<p>Option <em>ipaddr</em> can contains IP address, &#8216;dhcp&#8217;, or &#8216;none&#8217; string. In this example we describe configuration of 4 network interfaces:
* Interface <em>eth0</em> have short CIDR-notated form of IP address definition.
* Interface <em>eth1</em>
* Interface <em>eth2</em> will be configured to use dhcp protocol.
* Interface <em>eth3</em> will be configured as interface without IP address. Often you will need to create &#8220;master&#8221; interface for 802.1q vlans (in native linux implementation) or as slave interface for bonding.</p>
<p>CIDR-notated form of IP address has more priority, that classic <em>ipaddr</em> and <em>netmask</em> definition.
If you omitted <em>natmask</em> and did not use CIDR-notated form &#8211; default <em>netmask</em> value will be used as &#8216;255.255.255.0&#8217;.:</p>
<div class="highlight-python"><pre>### Multiple IP addresses for one interface (aliases)

l23network::l3::ifconfig {"eth0":
  ipaddr =&gt; ['192.168.0.1/24', '192.168.1.1/24', '192.168.2.1/24']
}</pre>
</div>
<p>You can pass a list of CIDR-notated IP addresses to the <em>ipaddr</em> parameter to assign many IP addresses to one interface.  This will create aliases (not subinterfaces). Array can contain one or more elements.</p>
<div class="highlight-python"><pre>### UP and DOWN interface order

l23network::l3::ifconfig {"eth1":
  ipaddr=&gt;'192.168.1.1/24'
}
l23network::l3::ifconfig {"br-ex":
  ipaddr=&gt;'192.168.10.1/24',
  ifname_order_prefix='ovs'
}
l23network::l3::ifconfig {"aaa0":
  ipaddr=&gt;'192.168.20.1/24',
  ifname_order_prefix='zzz'
}</pre>
</div>
<p>Centos and Ubuntu (at startup OS) start and configure network interfaces in alphabetical order
by interface configuration file names. In the example above we change configuration process order by <em>ifname_order_prefix</em> keyword. We will have this order:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ifcfg</span><span class="o">-</span><span class="n">eth1</span>
<span class="n">ifcfg</span><span class="o">-</span><span class="n">ovs</span><span class="o">-</span><span class="n">br</span><span class="o">-</span><span class="n">ex</span>
<span class="n">ifcfg</span><span class="o">-</span><span class="n">zzz</span><span class="o">-</span><span class="n">aaa0</span>
</pre></div>
</div>
<p>And OS will configure interfaces br-ex and aaa0 after eth0:</p>
<div class="highlight-python"><pre>### Default gateway

l23network::l3::ifconfig {"eth1":
    ipaddr                =&gt; '192.168.2.5/24',
    gateway               =&gt; '192.168.2.1',
    check_by_ping         =&gt; '8.8.8.8',
    check_by_ping_timeout =&gt; '30'
}</pre>
</div>
<p>In this example we define default <em>gateway</em> and options for waiting  so that the network stays up.
Parameter <em>check_by_ping</em> define IP address, that will be pinged. Puppet will be blocked for waiting response for <em>check_by_ping_timeout</em> seconds.
Parameter <em>check_by_ping</em> can be IP address, &#8216;gateway&#8217;, or &#8216;none&#8217; string for disabling checking.
By default gateway will be pinged.</p>
<div class="highlight-python"><pre>### DNS-specific options

l23network::l3::ifconfig {"eth1":
    ipaddr          =&gt; '192.168.2.5/24',
    dns_nameservers =&gt; ['8.8.8.8','8.8.4.4'],
    dns_search      =&gt; ['aaa.com','bbb.com'],
    dns_domain      =&gt; 'qqq.com'
}</pre>
</div>
<p>Also we can specify DNS nameservers, and search list that will be inserted (by resolvconf lib) to /etc/resolv.conf .
Option <em>dns_domain</em> implemented only in Ubuntu.</p>
<div class="highlight-python"><pre>### DHCP-specific options

l23network::l3::ifconfig {"eth2":
    ipaddr          =&gt; 'dhcp',
    dhcp_hostname   =&gt; 'compute312',
    dhcp_nowait     =&gt; false,
}</pre>
</div>
</div>
<div class="section" id="bonding">
<h2>Bonding<a class="headerlink" href="#bonding" title="Permalink to this headline">¶</a></h2>
<p>### Using standard linux bond (ifenslave)
For bonding two interfaces you need to:
* Specify these interfaces as interfaces without IP addresses
* Specify that the interfaces depend on the master-bond-interface
* Assign IP address to the master-bond-interface.
* Specify bond-specific properties for master-bond-interface (if defaults are not suitable for you)</p>
<p>for example (defaults included):</p>
<div class="highlight-python"><pre>l23network::l3::ifconfig {'eth1': ipaddr=&gt;'none', bond_master=&gt;'bond0'} -&gt;
l23network::l3::ifconfig {'eth2': ipaddr=&gt;'none', bond_master=&gt;'bond0'} -&gt;
l23network::l3::ifconfig {'bond0':
    ipaddr          =&gt; '192.168.232.1',
    netmask         =&gt; '255.255.255.0',
    bond_mode       =&gt; 0,
    bond_miimon     =&gt; 100,
    bond_lacp_rate  =&gt; 1,
}</pre>
</div>
<p>More information about bonding network interfaces you can get in manuals for your operating system:
* <a class="reference external" href="https://help.ubuntu.com/community/UbuntuBonding">https://help.ubuntu.com/community/UbuntuBonding</a>
* <a class="reference external" href="http://wiki.centos.org/TipsAndTricks/BondingInterfaces">http://wiki.centos.org/TipsAndTricks/BondingInterfaces</a></p>
<p>### Using Open vSwitch
For bonding two interfaces you need:
* Specify OVS bridge
* Specify special resource &#8220;bond&#8221; and add it to bridge. Specify bond-specific parameters.
* Assign IP address to the newly-created network interface (if needed).</p>
<p>In this example we add &#8220;eth1&#8221; and &#8220;eth2&#8221; interfaces to bridge &#8220;bridge0&#8221; as bond &#8220;bond1&#8221;.</p>
<div class="highlight-python"><pre>l23network::l2::bridge{'bridge0': } -&gt;
l23network::l2::bond{'bond1':
    bridge     =&gt; 'bridge0',
    ports      =&gt; ['eth1', 'eth2'],
    properties =&gt; [
       'lacp=active',
       'other_config:lacp-time=fast'
    ],
} -&gt;
l23network::l3::ifconfig {'bond1':
    ipaddr          =&gt; '192.168.232.1',
    netmask         =&gt; '255.255.255.0',
}</pre>
</div>
<p>Open vSwitch provides lot of parameters for different configurations.
We can specify them in the &#8220;properties&#8221; option as a list of parameter=value
(or parameter:key=value) strings.
The most of them you can see in [open vSwitch documentation page](http://openvswitch.org/support/).</p>
</div>
<div class="section" id="q-vlan-access-ports">
<h2>802.1q vlan access ports<a class="headerlink" href="#q-vlan-access-ports" title="Permalink to this headline">¶</a></h2>
<p>### Using standard linux way
We can use tagged vlans over ordinary network interfaces (or over bonds).
L23networks support two variants of naming vlan interfaces:
* <em>vlanXXX</em> &#8211; 802.1q tag gives from the vlan interface name, but you need to specify
parent interface name in the <strong>vlandev</strong> parameter.
* <em>eth0.101</em> &#8211; 802.1q tag and parent interface name gives from the vlan interface name</p>
<p>If you need to use 802.1q vlans over bonds &#8211; you can use only the first variant.</p>
<p>In this example we can see both variants:</p>
<div class="highlight-python"><pre>l23network::l3::ifconfig {'vlan6':
    ipaddr  =&gt; '192.168.6.1',
    netmask =&gt; '255.255.255.0',
    vlandev =&gt; 'bond0',
}
l23network::l3::ifconfig {'vlan5':
    ipaddr  =&gt; 'none',
    vlandev =&gt; 'bond0',
}
L23network:L3:Ifconfig['bond0'] -&gt; L23network:L3:Ifconfig['vlan6'] -&gt; L23network:L3:Ifconfig['vlan5']

l23network::l3::ifconfig {'eth0':
    ipaddr  =&gt; '192.168.0.5',
    netmask =&gt; '255.255.255.0',
    gateway =&gt; '192.168.0.1',
} -&gt;
l23network::l3::ifconfig {'eth0.101':
    ipaddr  =&gt; '192.168.101.1',
    netmask =&gt; '255.255.255.0',
} -&gt;
l23network::l3::ifconfig {'eth0.102':
    ipaddr  =&gt; 'none',
}</pre>
</div>
<p>### Using Open vSwitch
In the Open vSwitch all internal traffic is virtually tagged.
For creating the 802.1q tagged access port you need to specify vlan tag when adding a port to a bridge.
In this example we create two ports with tags 10 and 20, and assign an IP address to interface with tag 10:</p>
<div class="highlight-python"><pre>l23network::l2::bridge{'bridge0': } -&gt;
l23network::l2::port{'vl10':
    bridge  =&gt; 'bridge0',
    type    =&gt; 'internal',
    port_properties =&gt; [
        'tag=10'
    ],
} -&gt;
l23network::l2::port{'vl20':
    bridge  =&gt; 'bridge0',
    type    =&gt; 'internal',
    port_properties =&gt; [
        'tag=20'
    ],
} -&gt;
l23network::l3::ifconfig {'vl10':
    ipaddr  =&gt; '192.168.101.1/24',
} -&gt;
l23network::l3::ifconfig {'vl20':
    ipaddr  =&gt; 'none',
}</pre>
</div>
<p>Information about vlans in open vSwitch you can get in [open vSwitch documentation page](<a class="reference external" href="http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/">http://openvswitch.org/support/config-cookbooks/vlan-configuration-cookbook/</a>).</p>
<p><strong>IMPORTANT:</strong> You can&#8217;t use vlan interface names like vlanXXX if you do not want double-tagging of your network traffic.</p>
<p>&#8212;
When I began to write this module, I checked <a class="reference external" href="https://github.com/ekarlso/puppet-vswitch">https://github.com/ekarlso/puppet-vswitch</a>. Elcarso, big thanks...</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">Fuel for OpenStack 3.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Mirantis.
      Last updated on 2013/07/22.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>